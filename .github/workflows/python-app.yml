name: App test, build and publish to PyPI
on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"

      - run: uv sync

      - name: Run Ruff
        uses: astral-sh/ruff-action@v3 # Use the official action
        with:
          # Optional: specify arguments (default is 'check')
          args: "check --output-format=github"
          # Optional: specify source directory (default is '.')
          src: "src/"

      - name: Test with pytest
        id: pytest
        run: |
          uv run pytest -v --tb=short 2>&1 | tee pytest-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          PYTEST_OUTPUT: ${{ steps.pytest.outputs.exit_code }}
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('pytest-output.txt', 'utf8');
            const exitCode = process.env.PYTEST_OUTPUT;

            const testStatus = exitCode === '0' ? '‚úÖ All tests passed' : '‚ùå Some tests failed';

            const body = `## üß™ Test & Quality Check Results

            ### Summary
            - ${testStatus}
            - ‚úÖ Ruff linting passed
            - ‚úÖ Type checking (ty) passed

            ### üìä Pytest Results

            <details>
            <summary>Click to view full test output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ---
            **All checks must pass before merging.**`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if tests failed
        if: steps.pytest.outputs.exit_code != '0'
        run: exit 1

      - name: Typecheck with ty
        run: uvx ty check src

      - name: Generate job summary
        if: always()
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          echo "## üß™ Python App Test & Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pytest results
          if [ "${{ steps.pytest.outputs.exit_code }}" == "0" ]; then
            echo "‚úÖ **Pytest**: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Pytest**: Tests failed (exit code: ${{ steps.pytest.outputs.exit_code }})" >> $GITHUB_STEP_SUMMARY
          fi

          # Ruff results
          echo "‚úÖ **Ruff**: Linting passed" >> $GITHUB_STEP_SUMMARY

          # Typecheck results
          echo "‚úÖ **Type Check**: ty check passed" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 5 pytest-output.txt >> $GITHUB_STEP_SUMMARY || echo "No test output available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Release information (only on tags)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üì¶ Release Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version**: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # PyPI publish status
            if [ "${{ job.status }}" == "success" ]; then
              echo "‚úÖ **PyPI**: Published to https://pypi.org/project/nagios-public-status-page/$VERSION/" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Install command:**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "pip install nagios-public-status-page==$VERSION" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # GitHub Release
              echo "‚úÖ **GitHub Release**: Created at https://github.com/${{ github.repository }}/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Distribution files:**" >> $GITHUB_STEP_SUMMARY
              echo "- \`nagios_public_status_page-$VERSION.tar.gz\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`nagios_public_status_page-$VERSION-py3-none-any.whl\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **PyPI**: Publish failed or skipped" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        id: get_version
        run: |
          # Remove 'refs/tags/v' prefix to get version
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update version in pyproject.toml
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Update version in pyproject.toml using sed
          sed -i 's/^version = .*/version = "${{ steps.get_version.outputs.version }}"/' pyproject.toml
          echo "Updated pyproject.toml version to ${{ steps.get_version.outputs.version }}"
          # Show the change
          grep "^version = " pyproject.toml

      - name: Build and publish to PyPI
        if: startsWith(github.ref, 'refs/tags/v')
        run: uv build && uv publish -t ${{ secrets.PYPI_TOKEN }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.whl
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
