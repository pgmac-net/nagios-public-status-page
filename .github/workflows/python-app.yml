name: App test, build and publish to PyPI
run-name: Test, lint and typecheck
on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.13"

      - run: uv sync

      - name: Run Ruff
        uses: astral-sh/ruff-action@v1 # Use the official action
        with:
          # Optional: specify arguments (default is 'check')
          args: "check --output-format=github"
          # Optional: specify source directory (default is '.')
          src: "src/"

      - name: Test with pytest
        id: pytest
        run: |
          uv run pytest -v --tb=short 2>&1 | tee pytest-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with pytest results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('pytest-output.txt', 'utf8');
            const exitCode = '${{ steps.pytest.outputs.exit_code }}';

            const status = exitCode === '0' ? '‚úÖ All tests passed!' : '‚ùå Some tests failed';
            const body = `## Pytest Results\n\n${status}\n\n<details>\n<summary>Click to view test output</summary>\n\n\`\`\`\n${output}\n\`\`\`\n\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if tests failed
        if: steps.pytest.outputs.exit_code != '0'
        run: exit 1

      - name: Typecheck with ty
        run: uvx ty check src

      - name: Generate job summary
        if: always()
        run: |
          echo "## üß™ Python App Test & Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pytest results
          if [ "${{ steps.pytest.outputs.exit_code }}" == "0" ]; then
            echo "‚úÖ **Pytest**: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Pytest**: Tests failed (exit code: ${{ steps.pytest.outputs.exit_code }})" >> $GITHUB_STEP_SUMMARY
          fi

          # Ruff results
          echo "‚úÖ **Ruff**: Linting passed" >> $GITHUB_STEP_SUMMARY

          # Typecheck results
          echo "‚úÖ **Type Check**: ty check passed" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 5 pytest-output.txt >> $GITHUB_STEP_SUMMARY || echo "No test output available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check project version
        uses: maybe-hello-world/pyproject-check-version@v4
        id: versioncheck
        with:
          pyproject-path: "./pyproject.toml"

      - name: Publish the pypi project
        if: steps.versioncheck.outputs.local_version_is_higher == 'true'
        run: uv build && uv publish -t ${{ secrets.PYPI_TOKEN }}
